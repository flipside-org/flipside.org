<!DOCTYPE html>
<!--[if IE 8]>         <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="Using open source technology, Flipside builds web-based tools that help organisations create social impact." />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
  <meta property="og:site_name" content="Flipside" />

  <meta property="og:type" content="article" />

<meta property="og:title" content="Scripted Tilemill exports - Flipside" />
<meta property="og:url" content="http://flipside.org/notes/scripted-tilemill-exports/" />

  <meta property="og:description" content="A pretty handy feature that is not well documented in TileMill, is the possibility to call the export command from the command line. This is useful, for example, when you have to export a project repeatedly with almost the same..." >


  <meta property="og:image" content="http://flipside.org/images/notes/scripted-export.png" />

<meta property="og:image" content="http://flipside.org/images/meta/og-image.png" />  
  <meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@flipside_org">

  <meta name="twitter:creator" content="@oBirdman">

<meta name="twitter:title" content="Scripted Tilemill exports - Flipside">

  <meta property="twitter:description" content="A pretty handy feature that is not well documented in TileMill, is the possibility to call the export command from the command line. This is useful, for example, when you have to export a project r..." >


  
    <meta property="twitter:image" content="http://flipside.org/images/notes/scripted-export.png" />
  

  
  <link rel="shortcut icon" href="http://flipside.org/images/meta/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="http://flipside.org/images/meta/apple-touch-icon.png" />
  <link rel="apple-touch-icon" sizes="57x57" href="http://flipside.org/images/meta/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="http://flipside.org/images/meta/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="http://flipside.org/images/meta/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="http://flipside.org/images/meta/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="http://flipside.org/images/meta/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="http://flipside.org/images/meta/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="http://flipside.org/images/meta/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="http://flipside.org/images/meta/apple-touch-icon-152x152.png" />
  
  <title>Flipside - Scripted Tilemill exports</title>
  
  <link type="text/plain" rel="author" href="http://flipside.org/humans.txt" />
  <link rel="stylesheet" href="/css/app.css">
  <link href='http://fonts.googleapis.com/css?family=Lato:400,400italic,700' rel='stylesheet' type='text/css'>
  <link rel="alternate" type="application/rss+xml" title="Flipside" href="http://flipside.org/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-33134074-1', 'flipside.org');
    ga('send', 'pageview');
  </script>
</head>
<body>
  <!--[if lt IE 9]>
    <div id="nocando">
      <h1>Your browser is not supported.</h1>
      <p>To view this website, we recommend using the <strong>latest version</strong> of Chrome, Safari or Firefox.</p>
      <p>Here: <a href="http://browsehappy.com/" title="Visit Broser happy">upgrade your browser</a>!</p>
    </div>
  <![endif]-->
  
  <div id="site-canvas">
    <header id="site-hdr" role="banner">
      <div class="row">
        <h1 id="site-title">
          <a href="http://flipside.org" title="Go home"><img src="/images/flipside-logo.svg" alt="Flipside logo" title="Flipside" /><span class="visually-hidden">Flipside</span></a>
        </h1>
        <nav id="primary" role="navigation">
	<a href="#nav-links" class="toggle"><span class="visually-hidden">Menu</span></a>
	<ul class="links" id="nav-links">
    
    <li>
    
			<a href="/" title="Go home">Home</a>
		</li>
		
    <li>
    
			<a href="/projects/" title="Project hub">Projects</a>
		</li>
		
		<li>
		
			<a href="/notes/" title="Notes hub">Notes</a>
		</li>
		
    <li>
    
			<a href="/about/" title="About Flipside">About</a>
		</li>
		
    <li>
    
			<a href="/contact/" title="Contact page">Contact</a>
		</li>
	</ul>
</nav>
      </div>
    </header>

    <main id="site-body" role="main">
      








<article class="has-sidebar">

  
  <header class="banner">
  
  	<div class="row">
    	<div class="heading">
        <h1 class="title">Scripted Tilemill exports</h1>
        <h2 class="section-title"><em>Under</em> Notes</h2>
      </div>
    	<div class="actions">
        <ul class="notes-navigation">
          <li id="social-share">
  <a class="toggle share" href="#share-links"><span>Social share</span></a>
  <ul class="links" id="share-links">
    <li class="facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://flipside.org/notes/scripted-tilemill-exports/" target="_blank" class="facebook" title="Share this on Facebook">Facebook</a>
    </li>
    <li class="twitter">
      <a href="https://twitter.com/share?url=http://flipside.org/notes/scripted-tilemill-exports/" target="_blank" class="twitter" title="Share this on Twitter">Twitter</a>
    </li>
    <li class="google-plus">
      <a href="https://plus.google.com/share?url=http://flipside.org/notes/scripted-tilemill-exports/" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600'); return false;" class="google-plus" title="Share this on Google+">Google+</a>
    </li>
  </ul>
</li>
          <li>
          
            <a href="/notes/jekyll-talk/" title="Previous note" class="previous"><span class="visually-hidden">previous</span></a>
          
          </li>
          <li>
          
            <a href="/notes/data-collection-with-airwolf/" title="Next note" class="next"><span class="visually-hidden">next</span></a>
          
          </li>
        </ul>
      </div>
    </div>
  </header>

 	<div class="row">
		<div class="content">
      <p>A pretty handy feature that is not well documented in <a href="http://mapbox.com/tilemill/">TileMill</a>, is the possibility to call the export command from the command line. This is useful, for example, when you have to export a project repeatedly with almost the same settings.</p>

<p>In our case we have a dataset with eleven years worth of point data. For our final map, we want to visualize each of these years in a separate layer. Since a TileMill export only contains one layer, we need to export each of these years one by one. To facilitate this process, we create a simple bash script that loops over the years and calls the export process.</p>

<p>To start, we add a selector to the Carto stylesheet that limits the data to a particular year.</p>

<figure class="highlight"><pre><code class="language-css" data-lang="css"><span class="nf">#point-data</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">year</span><span class="o">=</span><span class="m">2001</span><span class="p">]</span> <span class="err">{</span>
		<span class="n">marker</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">10px</span>
		<span class="n">marker</span><span class="o">-</span><span class="n">fill</span><span class="o">:</span> <span class="m">#F1C40F</span><span class="p">;</span>
		<span class="o">...</span>
	<span class="p">}</span>
<span class="err">}</span></code></pre></figure>

<p>Our bash script loops over these years and basically does the following:</p>

<ol>
  <li>changes the selector in the style.mss;</li>
  <li>changes the project’s metadata in project.mml;</li>
  <li>export the project to .mbtiles format; and</li>
  <li>upload it to MapBox.</li>
</ol>

<h3 id="bash-script">Bash script</h3>
<p>First we define the range that the script should loop over.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="c">#Make sure the field separator is a &#39;,&#39;</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;,&#39;</span>
<span class="c">#Define the years to be exported</span>
<span class="nv">range</span><span class="o">=</span>2001,2002,2003,2004

<span class="k">for</span> year in <span class="nv">$range</span>
<span class="k">do</span></code></pre></figure>

<p>With <code>sed</code> we search and replace the selector in the style.mss stylesheet for the correct year.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sed -i -r -e <span class="s1">&#39;s/year=[0-9]{4}/year=&#39;</span><span class="nv">$year</span><span class="s1">&#39;/g&#39;</span> ~/Documents/MapBox/project/fire-project/style.mss</code></pre></figure>

<p>Using <code>sed</code> again, we update the project.mml and change the project name and description so they contain a reference to the year. This helps greatly when browsing the layers on MapBox.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sed -i -r -e <span class="s1">&#39;s/\&quot;name\&quot;: \&quot;Fire data\&quot;/\&quot;name\&quot;: \&quot;Fire data &#39;</span><span class="nv">$year</span><span class="s1">&#39;\&quot;/g&#39;</span> ~/Documents/MapBox/project/fire-project/project.mml
sed -i -r -e <span class="s1">&#39;s/\&quot;description\&quot;: \&quot;Detailed point data for fires\&quot;/\&quot;description\&quot;: \&quot;Detailed point data for fires &#39;</span><span class="nv">$year</span><span class="s1">&#39;\&quot;/g&#39;</span> ~/Documents/MapBox/project/fire-project/project.mml</code></pre></figure>

<p>With the right selector set in the style.mss, we are ready to export the layer. The actual export command is pretty self-explanatory. The basic syntax on Ubuntu is: <code>/usr/share/tilemill/index.js export [name of project] [destination of export]</code>, where the export path is relative to the home folder.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/usr/share/tilemill/index.js <span class="nb">export </span>fire-project ~/Documents/fire-project-<span class="nv">$year</span>.mbtiles --bbox<span class="o">=</span><span class="s1">&#39;-10.2063,36.5361,-5.8557,42.4640&#39;</span> --format<span class="o">=</span>mbtiles --minzoom<span class="o">=</span><span class="m">4</span> --maxzoom<span class="o">=</span><span class="m">13</span> --metatile<span class="o">=</span>2</code></pre></figure>

<p>The export command comes with a couple of other options that we didn’t include in our example. For a full list you can run <code>/usr/share/tilemill/index.js export --help</code>.</p>

<p>Once exported, we also upload the layer to MapBox hosting with our script. The command to invoke is basically the same as the one used for the export, except for the <code>--format=upload</code>.<br />
We also add the year to the name of the project to prevent issues when uploading the tiles. If we use the same name for every layer, MapBox simply overwrites the one that was previously uploaded.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/usr/share/tilemill/index.js <span class="nb">export </span>fire-project-<span class="nv">$year</span> ~/Documents/fire-project-<span class="nv">$year</span>.mbtiles --format<span class="o">=</span>upload --syncAccount<span class="o">=</span><span class="s2">&quot;&quot;</span> --syncAccessToken<span class="o">=</span><span class="s2">&quot;&quot;</span></code></pre></figure>

<p>Note that the –syncAccount and –syncAccessToken options are left empty in this example, but you have to provide them to be able to upload the layers.</p>

<p>This is all you need to export a TileMill project with a bash script. To see a more complete example of this script, you can have a look at the following Gist: <a href="https://gist.github.com/olafveerman/5391804">https://gist.github.com/olafveerman/5391804</a>.</p>

    </div>
    <aside role="complementary">
      <section class="details">
        <h1>Details</h1>
        <dl>
          <dt class="visually-hidden">Author</dt>
          <dd class="bfc-objects">
            <a href="/about#team" title="Team page">
              <div class="media">
                <img src="/images/team/olaf-thumb-224x224-d39a62.jpg" class="thumb" >
              </div>
              <div class="teaser">
                <h2>Olaf Veerman</h2>
                <p class="meta">Founder</p>
              </div>
            </a>
          </dd>
          
          
            
            
            
            <dt>Published</dt>
            <dd>17 Apr. 2013 <em>in</em> <a href="" title="" title="More in this category"></a></dd>
          
        </dl>
      </section>
      
        






      
    </aside>
  </div>

</article>
    </main>

    
    
    <footer id="site-ftr" role="contentinfo">
        <div class="row">
          <div class="social">
            <ul>
              <li class="twitter"><a href="http://twitter.com/flipside_org" title="Flipside on Twitter" target="_blank"><span class="visually-hidden">Twitter</span></a></li>
              <li class="github"><a href="http://github.com/flipside-org" title="Flipside on Github" target="_blank"><span class="visually-hidden">Github</span></a></li>
              <li class="flickr"><a href="http://flickr.com/photos/flipside-org" title="Flipside on Flickr" target="_blank"><span class="visually-hidden">Flickr</span></a></li>
            </ul>
          </div>
          <p class="about">
            <span class="fs">Flipside 2014 </span> 
            <a href="/about#colophon" class="cta-inline" title="Colophon">Colophon</a>
          </p>
        </div>
    </footer>
  </div>
  <script src="/scripts/foundation.min.js"></script>
  <script src="/scripts/flipside.min.js"></script>
</body>
</html>